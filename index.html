<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="shortcut icon" href="temp_favicon.ico">
<title>Picture voting machine</title>
<script src="js/jquery-2.2.1.js"></script>
<link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap.min.css">
<script>
	var globalResponseObj = {};

	function displayImageInfo(imageObj) {
		// Creating the title DOM element.
		var title = document.createElement("h4");
		title.innerHTML = "TITLE: " + imageObj.title;
		document.body.appendChild(title);
		document.body.appendChild(document.createElement("br"));

		// Creting the image DOM element.
		var img = document.createElement("img");
		img.src = imageObj.url;
		img.alt = "You should be seeing an image from this url: " + imageObj.url;
		document.body.appendChild(img);

		// Creating a list of tags.
		var tagList = document.createElement("ul");
		document.body.appendChild(tagList);

		// Creating tags based on the length of the tag category array.
		var tag = document.createElement("li");
		if (imageObj.tags != null) {
			for (var i = 0; i < imageObj.tags.length; i++) {
				tag.innerHTML = imageObj.tags[i];
				document.getElementsByTagName('ul')[0].appendChild(tag);
			}
			
		} else {
			tag.innerHTML = "You don't got no tags on this image.";
			document.getElementsByTagName('ul')[0].appendChild(tag);
		}
		

		// Creating a button to submit votes and tags.
		var submitButton = document.createElement("button");
		submitButton.type = "button";
		submitButton.innerHTML = "SUBMIT TAGS, VOTE and NEXT!";
		submitButton.onclick = function() {
			voteAndUpdate();
		}
		document.body.appendChild(submitButton);

		// Check function to ensure there is a global object to receive this particular data.
		if (typeof globalResponseObj == "undefined") {
			console.log("the resonse object NOT has been defined.");
		}
		else {
			globalResponseObj = imageObj;
		}
	}

	function checkStatePut() {
		if (this.readyState === 4 && this.status === 200) {
			console.log("The put command has readyState 4 and status 200");
			// Call a new function to get a new Url object from the server.
			nextImage();
		}
	}

	function voteAndUpdate() {
		if (typeof globalResponseObj == "undefined") {
			console.log("voteAndUpdate globalResponseObj is not define.");
		}
		var obj = globalResponseObj;
		var xhr = new XMLHttpRequest();
		var url = "http://192.168.56.101:8081/images";
		var tagInput = document.getElementsByName('newTag')[0].value;
		var body = JSON.stringify({title: obj.title, url: obj.url, id: obj.id, 
			tag: tagInput, score: 1});

		xhr.open('PUT', url, true);
 		xhr.send(body);
		xhr.onreadystatechange = checkStatePut;

 		console.log("The entire body " + body);
	}

	function checkNewImage() {
		if (this.readyState === 4 && this.status === 200) {
			var imageObj = JSON.parse(this.responseText);
			document.getElementsByTagName('img')[0].src = imageObj.url;
			document.getElementsByName('newTag')[0].value = "";
		}
	}

	// This function gets a new image asyncronously for th epage upon a successful 
	// PUT of the image information from the user.
	function nextImage() {
		if (window.XMLHttpRequest) {
			httpRequest = new XMLHttpRequest();
		}
		else if (window.ActiveXObject) {
			try {
				httpRequest = new ActiveXObject("Msxm12.XMLHTTP");
			}
			catch (e) {
				try {
					httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
				}
				catch (e) {}
			}
		} // End of else if statement.

		var url = "http://192.168.56.101:8081/images";
		this.httpRequest.open('GET', url, true);
		this.httpRequest.send();
		this.httpRequest.onreadystatechange = checkNewImage;
	}

	// This function wipes out the old score and makes it 1.
	function upVote() {
		globalResponseObj.score = 1;
		console.log(globalResponseObj);
	}

	// This functions makes the score of the photo -1.
	function downVote() {
		globalResponseObj.score = -1;
		console.log(globalResponseObj);
	}

	// This function makes the score of the photo 0.
	function dontCareVote() {
		globalResponseObj.score = 0;
		console.log(globalResponseObj);
	}

	function checkState() {
		if (this.readyState === 4 && this.status === 200) {
			var imageObj = JSON.parse(this.responseText);
			console.log(imageObj);
			displayImageInfo(imageObj);
		}
	}

	window.onload = function() {
		// Preloading the first image url, tags
		if (window.XMLHttpRequest) {
			httpRequest = new XMLHttpRequest();
		}
		else if (window.ActiveXObject) {
			try {
				httpRequest = new ActiveXObject("Msxm12.XMLHTTP");
			}
			catch (e) {
				try {
					httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
				}
				catch (e) {}
			}
		}	// End of else if statement.

		var url = "http://192.168.56.101:8081/images";	// Gets a single image JSON.

		this.httpRequest.open('GET', url, true);
		this.httpRequest.send();
		this.httpRequest.onreadystatechange = checkState;
	}
</script>
</head>
<body>
	<h2>Welcome to the picture voting app</h2>
	<br>
	<form>
		Please enter a new tag to help label this image as hot or not: <input type="text" name="newTag">
	</form>
	<button id="upVote" onclick="upVote()">VOTE FOR HOT!!</button>
	<button id="downVote" onclick="downVote()">VOTE NOT NOT NOT HOT!!!</button><br>
	<button id="noVote" onclick="dontCareVote()">I DON'T CARE! DO YOU HEAR ME!!!!!</button>
</body>
</html>
